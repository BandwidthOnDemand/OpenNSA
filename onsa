#!/usr/bin/env python

import os
import sys
import socket

from twisted.python import log, usage
from twisted.internet import reactor, defer

from opennsa import setup
from opennsa.cli import parser, commands, defaultsreader, logobserver


CLI_DEFAULTS            = '.opennsa-cli'
WSDL_DEFAULT_DIRECTORY  = '/usr/local/share/nsi/wsdl'
REQUESTER_URL_BASE      = 'http://%s:%i/NSI/services/ConnectionService'


def doMain():
    config = parser.Options()
    try:
        config.parseOptions()
    except usage.UsageError, errortext:
        print '%s: %s' % (sys.argv[0], errortext)
        print '%s: Try --help for usage details.' % (sys.argv[0])
        return

    observer = logobserver.SimpleObserver(sys.stdout)
    log.startLoggingWithObserver(observer.emit)

    if config[parser.VERBOSE]:
        observer.debug = True

    # read defaults
    defaults_file = config[parser.DEFAULTSFILE] or os.path.join( os.path.expanduser('~'), CLI_DEFAULTS )
    if os.path.exists(defaults_file):
        defaults = defaultsreader.readDefaults( open(defaults_file) )
    else:
        defaults = {}

    print "Defaults:"
    for k,v in defaults.items():
        print " ", k, ":", v

    wsdl_dir = config[parser.WSDL_DIRECTORY] or defaults.get(parser.WSDL_DIRECTORY) or WSDL_DEFAULT_DIRECTORY
    host = config[parser.HOST] or defaults[parser.HOST] or socket.getfqdn()
    port = config[parser.PORT] or defaults[parser.PORT] or 7080
    requester_url = REQUESTER_URL_BASE % (host, port)

    client, service, factory = setup.createClient(host, port, wsdl_dir)
    reactor.listenTCP(port, factory)

    if config.subCommand == 'reserve':
        return commands.reserve(client,
                                requester_url,
                                config.subOptions['serviceurl'],
                                config.subOptions['topologyfile'],
                                config.subOptions['network'],
                                config.subOptions['serviceurl'],
                                config.subOptions['provider'],
                                config.subOptions['requester'],
                                config.subOptions['source-stp'],
                                config.subOptions['dest-stp'])

    elif config.subCommand == 'provision':
        return commands.provision()

    elif config.subCommand == 'release':
        return commands.release()

    elif config.subCommand == 'terminate':
        return commands.terminate()

    elif config.subCommand == 'querysummary':
        return commands.querysummary()

    elif config.subCommand == 'querydetails':
        return commands.querydetails()

    else:
        print "No subcommand specified"
        print '%s: Try --help for usage details.' % (sys.argv[0])
        return



def main():

    def printError(error):
        if error.type == SystemExit:
            return
        #print "Error: %s" % error.value
        log.err(error)

    d = defer.maybeDeferred(doMain)
    d.addErrback(printError)
    d.addBoth(lambda _ : reactor.stop())
    return d


if __name__ == '__main__':
    reactor.callWhenRunning(main)
    reactor.run()

